<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å‹¤æ€ ç®¡ç†è¡¨ ç°¡æ˜“ãƒ“ãƒ¥ãƒ¼ã‚¢</title>
  <style>
    :root {
      --primary-color: #4a6da7;
      --secondary-color: #f5f7fa;
      --accent-color: #5c8bdc;
      --text-color: #333;
      --border-color: #ddd;
      --error-color: #e74c3c;
      --success-color: #2ecc71;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background-color: #f9f9f9;
      padding: 16px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 24px;
    }
    
    h1 {
      font-size: 1.8rem;
      color: var(--primary-color);
      margin-bottom: 2rem;
      text-align: center;
      font-weight: 700;
      letter-spacing: 0.05em;
    }
    
    #attendance {
      margin-top: 1.5rem;
    }
    
    .empty-result {
      text-align: center;
      padding: 20px;
      color: #777;
      font-style: italic;
    }
    
    .error {
      color: var(--error-color);
      margin-top: 1rem;
      padding: 10px;
      background-color: rgba(231, 76, 60, 0.1);
      border-radius: 4px;
      display: none;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #555;
    }
    
    .loading::after {
      content: "...";
      animation: dots 1.5s infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: "."; }
      40% { content: ".."; }
      60%, 100% { content: "..."; }
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.95rem;
    }
    
    th, td {
      padding: 12px 8px;
      border: 1px solid var(--border-color);
      text-align: left;
    }
    
    th {
      background-color: var(--secondary-color);
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    tr:hover {
      background-color: #f0f4f8;
    }
    
    .time-value {
      font-family: monospace;
      white-space: nowrap;
    }
    
    .events-cell {
      font-size: 0.9rem;
    }
    
    .text-success {
      color: var(--success-color);
      font-weight: bold;
    }
    
    .text-danger {
      color: var(--error-color);
      font-weight: bold;
    }
    
    .browser-error {
      text-align: center;
      padding: 30px 20px;
      color: var(--error-color);
      font-weight: bold;
    }
    
    .browser-error p {
      margin-bottom: 10px;
    }
    
    .user-info {
      text-align: center;
      margin-bottom: 20px;
      font-size: 0.9rem;
      color: #666;
    }
    
    .user-name {
      font-weight: bold;
      color: var(--primary-color);
    }
    
    /* æ‰‹å‹•å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .manual-form {
      background-color: var(--secondary-color);
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    
    .form-row {
      margin-bottom: 12px;
    }
    
    .form-row label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 0.9em;
    }
    
    .form-row input {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 16px;
    }
    
    .form-row button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
    }
    
    .form-row button:hover {
      background-color: var(--accent-color);
    }
    
    .form-toggle {
      text-align: center;
      margin-top: 15px;
      font-size: 0.9em;
      color: var(--accent-color);
      cursor: pointer;
      text-decoration: underline;
    }
    
    @media (max-width: 600px) {
      .container {
        padding: 16px 12px;
      }
      
      th, td {
        padding: 8px 4px;
        font-size: 0.85rem;
      }
      
      .events-cell {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>å‹¤æ€ ç®¡ç†è¡¨</h1>
    
    <!-- ã‚µãƒ¼ãƒ“ã‚¹æ¡ˆå†…ãƒªãƒ³ã‚¯ã‚’è¿½åŠ  (ä¸€æ™‚çš„ã«éè¡¨ç¤º) 
    <div style="text-align: center; margin-bottom: 1.5rem;">
      <a href="./landing.html" style="
        display: inline-block;
        background: linear-gradient(135deg, #00C300 0%, #0084ff 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 500;
        transition: transform 0.2s, box-shadow 0.2s;
      " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
        ğŸ“‹ kintaiã‚µãƒ¼ãƒ“ã‚¹æ¡ˆå†…ãƒ»ç”³ã—è¾¼ã¿
      </a>
    </div>
    -->
    
    <div id="user-display" class="user-info" style="display: none;">
      <!-- <div class="loading">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­</div> -->
    </div>
    
    <div class="controls" style="margin-bottom: 1.5rem; text-align: center;">
      <label for="month-year-selector" style="margin-right: 8px; font-weight: 500;">è¡¨ç¤ºæœˆ:</label>
      <select id="month-year-selector" style="padding: 8px 12px; border-radius: 4px; border: 1px solid var(--border-color); font-size: 16px; background-color: #fff; max-width: 150px; cursor: pointer; appearance: auto;">
        <!-- é¸æŠè‚¢ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
      </select>
      

    </div>
    
    <div id="browser-error" class="browser-error" style="display: none;">
      <p>ã“ã®ãƒšãƒ¼ã‚¸ã¯LINEã‚¢ãƒ—ãƒªã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚</p>
      <p>å‹¤æ€ ç¢ºèªã¯LINEã‚¢ãƒ—ãƒªã‹ã‚‰è¡Œã£ã¦ãã ã•ã„ã€‚</p>
    </div>
    
  <div id="attendance"></div>
  <div class="error" id="error"></div>
    
    <div class="summary-section" style="margin-top: 1.5rem; padding: 15px; background-color: var(--secondary-color); border-radius: 6px; display: flex; justify-content: space-around;">
      <div>ç·åŠ´åƒæ™‚é–“: <span id="total-work-time">-</span></div>
      <div>ç·ä¼‘æ†©æ™‚é–“: <span id="total-break-time">-</span></div>
      <div>å®Ÿåƒæ—¥æ•°: <span id="work-days">-</span></div>
    </div>
    
    <!-- å•é¡Œè¨ºæ–­ãƒœã‚¿ãƒ³ï¼ˆé€šå¸¸ã¯éè¡¨ç¤ºï¼‰ -->
    <div id="debug-section" style="margin-top: 20px; display: none; text-align: center;">
      <button id="debug-button" style="padding: 8px 15px; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 4px;">å•é¡Œè¨ºæ–­</button>
      <div id="debug-info" style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9; display: none; text-align: left; font-size: 0.8rem;"></div>
    </div>
  </div>
  
  <!-- LIFF SDKï¼ˆæœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰ -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <script>
    // æœ€æ–°ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆæ›´æ–°æ¸ˆã¿ï¼‰
    const API_URL = 'https://script.google.com/macros/s/AKfycbyn0yEFrYUlhYjsG3V8tgw3qMExU23Hyn_Cc0zwQXF36kB74sfvEGpRNADjsqdDjEN5/exec';
    let isLiffInitialized = false;
    let currentLineUserId = null;
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let pendingScriptElements = []; // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã®å‚ç…§ã‚’ä¿æŒ
    const DEBUG_MODE = true; // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ç”¨é–¢æ•°
    function logDebug(message, data = null) {
      if (DEBUG_MODE) {
        if (data) {
          console.log('[DEBUG]', message, data);
        } else {
          console.log('[DEBUG]', message);
        }
      }
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«LIFFã‚’åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’ç¢ºèª
      const urlParams = new URLSearchParams(window.location.search);
      const isDebugMode = urlParams.get('debug') === 'true';
      const isTestMode = urlParams.get('test') === 'true';
      
      // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ãªã‚‰å•é¡Œè¨ºæ–­ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      if (isDebugMode) {
        document.getElementById('debug-section').style.display = 'block';
        
        // å•é¡Œè¨ºæ–­ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('debug-button').addEventListener('click', function() {
          const debugInfoEl = document.getElementById('debug-info');
          
          // ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’åé›†
          let debugInfo = '';
          
          // LIFFæƒ…å ±
          debugInfo += '<h4>LIFFæƒ…å ±</h4>';
          debugInfo += `<p>LIFFåˆæœŸåŒ–: ${isLiffInitialized ? 'æˆåŠŸ' : 'æœªå®Œäº†'}</p>`;
          
          if (window.liff) {
            try {
              debugInfo += `<p>LIFF SDK: åˆ©ç”¨å¯èƒ½</p>`;
              debugInfo += `<p>LINEã‚¢ãƒ—ãƒªå†…: ${liff.isInClient() ? 'ã¯ã„' : 'ã„ã„ãˆ'}</p>`;
              debugInfo += `<p>ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹: ${liff.isLoggedIn() ? 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿' : 'æœªãƒ­ã‚°ã‚¤ãƒ³'}</p>`;
            } catch (e) {
              debugInfo += `<p>LIFFæƒ…å ±ã‚¨ãƒ©ãƒ¼: ${e.message}</p>`;
            }
          } else {
            debugInfo += `<p>LIFF SDK: åˆ©ç”¨ä¸å¯</p>`;
          }
          
          // ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±
          debugInfo += '<h4>ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±</h4>';
          debugInfo += `<p>User Agent: ${navigator.userAgent}</p>`;
          
          // APIæƒ…å ±
          debugInfo += '<h4>APIæƒ…å ±</h4>';
          debugInfo += `<p>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: ${API_URL}</p>`;
          
          // LINE UserIDæƒ…å ±
          if (currentLineUserId) {
            debugInfo += '<h4>LINEæƒ…å ±</h4>';
            debugInfo += `<p>LINE User ID: ${currentLineUserId}</p>`;
            
            // ãƒ†ã‚¹ãƒˆç”¨URLã‚’ç”Ÿæˆ
            const testDevUrl = `${window.location.origin}${window.location.pathname}?dev=true&mockUserId=${encodeURIComponent(currentLineUserId)}`;
            debugInfo += `<p>é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰URL: <a href="${testDevUrl}" target="_blank">${testDevUrl}</a></p>`;
            debugInfo += `<p>â€»ã“ã®URLã‚’å…±æœ‰ã™ã‚‹ã“ã¨ã§ã€ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã‚‚ãƒ†ã‚¹ãƒˆã§ãã¾ã™</p>`;
          }
          
          // APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
          debugInfo += '<h4>APIæ¥ç¶šãƒ†ã‚¹ãƒˆ</h4>';
          if (currentLineUserId) {
            // callbackãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ãŸç›´æ¥ãƒ†ã‚¹ãƒˆãƒªãƒ³ã‚¯
            const testUrl = `${API_URL}?action=getMonthlyAttendance&lineUserId=${encodeURIComponent(currentLineUserId)}&callback=console.log`;
            debugInfo += `<p>APIæ¥ç¶šãƒ†ã‚¹ãƒˆ: <a href="${testUrl}" target="_blank">ç›´æ¥æ¥ç¶šãƒ†ã‚¹ãƒˆ</a> (æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã™)</p>`;
            debugInfo += '<p>â€»ç›´æ¥æ¥ç¶šãƒ†ã‚¹ãƒˆãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦JSONå¿œç­”ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„</p>';
            
            // pingãƒ†ã‚¹ãƒˆ
            const pingUrl = `${API_URL}?action=ping`;
            debugInfo += `<p>å˜ç´”ãªAPIæ¥ç¶šãƒ†ã‚¹ãƒˆ: <a href="${pingUrl}" target="_blank">Ping</a></p>`;
            
            // ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚ç›´æ¥API URLã‚’è¡¨ç¤º
            debugInfo += `<p>ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãƒ†ã‚¹ãƒˆ:</p>`;
            debugInfo += `<code style="display:block; background:#f5f5f5; padding:5px; margin:5px 0; font-family:monospace; word-break:break-all;">
fetch('${API_URL}?action=ping').then(r=>r.text()).then(console.log).catch(console.error)
</code>`;
            
            // æ¨™æº–ã®JSONPå½¢å¼ãƒ†ã‚¹ãƒˆ
            const jsonpTestUrl = `${API_URL}?action=ping&callback=console.log`;
            debugInfo += `<p>JSONPå½¢å¼ãƒ†ã‚¹ãƒˆ: <a href="${jsonpTestUrl}" target="_blank">JSONP</a></p>`;
            
            // HTMLå†…ã§APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹ãƒ†ã‚¹ãƒˆ
            debugInfo += '<div id="api-test-result" style="margin:10px 0; padding:10px; background:#f9f9f9; border:1px solid #ddd; min-height:40px;">';
            debugInfo += '<button id="test-api-btn" style="padding:5px 10px; background:#4a6da7; color:white; border:none; border-radius:4px; cursor:pointer;">APIã‚’ãƒ†ã‚¹ãƒˆ</button>';
            debugInfo += '<div id="api-response" style="margin-top:10px; font-family:monospace; font-size:12px; white-space:pre-wrap;"></div>';
            debugInfo += '</div>';
          }
          
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æŒ‡ç¤º
          debugInfo += '<h4>å•é¡Œè§£æ±ºæ‰‹é †</h4>';
          debugInfo += '<ol>';
          debugInfo += '<li>ä¸Šè¨˜ã®æ¥ç¶šãƒ†ã‚¹ãƒˆãƒªãƒ³ã‚¯ã§ç›´æ¥APIã‚’å‘¼ã³å‡ºã—ã¦ã¿ã¦ãã ã•ã„</li>';
          debugInfo += '<li>LINEãƒœãƒƒãƒˆã«ã€Œå‡ºå‹¤ã€ã‚„ã€Œé€€å‹¤ã€ãªã©ã®ã‚³ãƒãƒ³ãƒ‰ã‚’é€ã‚Šã€æ‰“åˆ»ã—ã¦ãã ã•ã„</li>';
          debugInfo += '<li>å•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆã¯ã€ç®¡ç†è€…ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹LINE User IDã‚’ä¼ãˆã¦ãã ã•ã„</li>';
          debugInfo += '</ol>';
          
          // è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
          if (debugInfoEl.style.display === 'none') {
            debugInfoEl.innerHTML = debugInfo;
            debugInfoEl.style.display = 'block';
            
            // CORSçŠ¶æ…‹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            testCorsStatus();
            
            // APIãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            const testApiBtn = document.getElementById('test-api-btn');
            if (testApiBtn) {
              testApiBtn.addEventListener('click', function() {
                const responseEl = document.getElementById('api-response');
                if (responseEl) {
                  responseEl.innerHTML = 'APIãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...';
                  
                  // æ¨™æº–ã®JSONPæ–¹å¼ã§ãƒ†ã‚¹ãƒˆï¼ˆã‚ˆã‚Šå®‰å…¨ï¼‰
                  const callbackName = 'testApiCallback_' + Date.now();
                  window[callbackName] = function(data) {
                    responseEl.innerHTML = 'APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:\n' + JSON.stringify(data, null, 2);
                    delete window[callbackName];
                  };
                  
                  const script = document.createElement('script');
                  script.src = `${API_URL}?action=ping&callback=${callbackName}`;
                  script.onerror = function() {
                    responseEl.innerHTML = 'APIãƒ†ã‚¹ãƒˆå¤±æ•—ï¼šã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
                    delete window[callbackName];
                  };
                  
                  // 10ç§’ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                  const timeoutId = setTimeout(function() {
                    if (window[callbackName]) {
                      responseEl.innerHTML = 'APIãƒ†ã‚¹ãƒˆå¤±æ•—ï¼šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ';
                      delete window[callbackName];
                    }
                  }, 10000);
                  
                  document.body.appendChild(script);
                }
              });
            }
          } else {
            debugInfoEl.style.display = 'none';
          }
        });
      }
      
      // LIFFåˆæœŸåŒ–ã‚’å®Ÿè¡Œ
      initializeLiff().catch(error => {
        showError('ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
      });
    });
    
    // CORSçŠ¶æ…‹ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹é–¢æ•°
    function testCorsStatus() {
      const resultElement = document.getElementById('cors-test-result');
      if (!resultElement) return;
      
      // ãƒ†ã‚¹ãƒˆç”¨ã®URLã‚’è¨­å®š
      const testUrl = `${API_URL}?action=ping&t=${Date.now()}`;
      
      // ãƒ•ã‚§ãƒƒãƒAPIã§ãƒ†ã‚¹ãƒˆ
      fetch(testUrl, {
        method: 'GET',
        mode: 'cors',
        credentials: 'omit'
      })
      .then(response => {
        if (response.ok) {
          resultElement.innerHTML = `<span style="color:green">âœ“ CORSãƒªã‚¯ã‚¨ã‚¹ãƒˆæˆåŠŸ</span>`;
          return response.text();
        } else {
          resultElement.innerHTML = `<span style="color:red">âœ— CORSãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•— (HTTP ${response.status})</span>`;
          throw new Error(`HTTP error ${response.status}`);
        }
      })
      .then(data => {
        resultElement.innerHTML += `<br>å¿œç­”: ${data}`;
      })
      .catch(error => {
        console.error('CORS Test Error:', error);
        resultElement.innerHTML = `<span style="color:red">âœ— CORSãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}</span><br>JSONPã«ã‚ˆã‚‹é€šä¿¡ãŒå¿…è¦ã§ã™`;
        
        // JSONPã§ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
        resultElement.innerHTML += `<br>JSONPãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...`;
        const testJsonpUrl = `${API_URL}?action=ping&callback=handleJsonpTest&t=${Date.now()}`;
        resultElement.innerHTML += `<br>ãƒ†ã‚¹ãƒˆURL: ${testJsonpUrl}`;
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®šç¾©
        window.handleJsonpTest = function(data) {
          resultElement.innerHTML += `<br><span style="color:green">âœ“ JSONPãƒ†ã‚¹ãƒˆæˆåŠŸ</span><br>å¿œç­”: ${JSON.stringify(data)}`;
          delete window.handleJsonpTest;
        };
        
        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’ä½œæˆ
        const script = document.createElement('script');
        script.src = testJsonpUrl;
        script.onerror = function(error) {
          resultElement.innerHTML += `<br><span style="color:red">âœ— JSONPãƒ†ã‚¹ãƒˆã‚‚å¤±æ•—</span>`;
          resultElement.innerHTML += `<br>ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error ? JSON.stringify(error) : 'ã‚¨ãƒ©ãƒ¼æƒ…å ±ãªã—'}`;
          resultElement.innerHTML += `<br><br>ä»¥ä¸‹ã®æ‰‹é †ã‚’è©¦ã—ã¦ãã ã•ã„:<br>1. GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹<br>2. æ–°ã—ã„URLã‚’API_URLã«è¨­å®šã™ã‚‹<br>3. ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦å†ãƒ†ã‚¹ãƒˆ`;
          delete window.handleJsonpTest;
        };
        
        document.body.appendChild(script);

        // ç›´æ¥URLã§ã‚‚ãƒ†ã‚¹ãƒˆ
        resultElement.innerHTML += `<br><br>ç›´æ¥URLãƒ†ã‚¹ãƒˆ: <a href="${API_URL}?action=ping" target="_blank">ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯</a>`;
      });
    }
    
    // æœˆå¹´ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’ç”Ÿæˆ (ä¾‹: éå»12ãƒ¶æœˆ)
    function populateMonthYearSelector() {
        const select = document.getElementById('month-year-selector');
        if (!select) {
            return;
        }
        
        // æ—¢å­˜ã®é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
        select.innerHTML = '';
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å‰Šé™¤ï¼ˆé‡è¤‡ç™»éŒ²é˜²æ­¢ï¼‰
        select.removeEventListener('change', handleMonthYearChange);
        
        const today = new Date();
        // ä»Šæœˆã¨éå»11ãƒ¶æœˆåˆ†ã®é¸æŠè‚¢ã‚’è¿½åŠ 
        for (let i = 0; i < 12; i++) {
            let date = new Date(today.getFullYear(), today.getMonth() - i, 1);
            let year = date.getFullYear();
            let month = date.getMonth() + 1;
            let option = document.createElement('option');
            option.value = `${year}-${month.toString().padStart(2, '0')}`;
            option.textContent = `${year}å¹´${month}æœˆ`;
            select.appendChild(option);
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        select.addEventListener('change', handleMonthYearChange);
    }
    
    // æœˆå¹´å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ï¼ˆåˆ¥é–¢æ•°åŒ–ã—ã¦é‡è¤‡ç™»éŒ²é˜²æ­¢ï¼‰
    function handleMonthYearChange(event) {
        const selectedMonthYear = event.target.value;
        if (currentLineUserId && selectedMonthYear) {
            const [year, month] = selectedMonthYear.split('-');
            fetchUserAttendance(currentLineUserId, parseInt(year), parseInt(month));
        } else {
            showError('ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }
    }
    
    // LIFFã®åˆæœŸåŒ–
    async function initializeLiff() {
      try {
        // é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const isDevMode = urlParams.get('dev') === 'true';
        
        if (isDevMode) {
          const mockUserId = urlParams.get('mockUserId');
          if (mockUserId) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ä¿å­˜
            currentLineUserId = mockUserId;
            
            // æœˆå¹´ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
            populateMonthYearSelector();
            
            // åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—
            const selector = document.getElementById('month-year-selector');
            if (selector && selector.value) {
                const [year, month] = selector.value.split('-');
                await fetchUserAttendance(mockUserId, parseInt(year), parseInt(month));
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦å½“æœˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const today = new Date();
                await fetchUserAttendance(mockUserId, today.getFullYear(), today.getMonth() + 1);
            }
          } else {
            showError('é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ã§ã¯ mockUserId ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™');
          }
          return;
        }
        
        // LINEãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚§ãƒƒã‚¯
        if (!window.liff) {
          showBrowserError();
          return;
        }
        
        // LIFFåˆæœŸåŒ–
        await liff.init({ liffId: '2007458955-dVkEPq4E' }); // LIFF ID
        isLiffInitialized = true;
        
        // LINEãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã‹ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if (!liff.isInClient()) {
          showBrowserError();
          return;
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‹ã‚‰å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        try {
          // LINEã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—
          const profile = await liff.getProfile();
          const lineUserId = profile.userId;
          
          // LINE UserIDã‚’ä¿å­˜
          currentLineUserId = lineUserId;
          
          // æœˆå¹´ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–ãƒ»è¨­å®š
          populateMonthYearSelector(); 

          // åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—
          const selector = document.getElementById('month-year-selector');
          if (selector && selector.value) {
              const [year, month] = selector.value.split('-');
              await fetchUserAttendance(lineUserId, parseInt(year), parseInt(month));
          } else {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦å½“æœˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const today = new Date();
            await fetchUserAttendance(lineUserId, today.getFullYear(), today.getMonth() + 1);
          }
          
        } catch (profileError) {
          showError('LINEãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
      } catch (err) {
        showError('LINEã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      }
    }
    
    // ãƒ–ãƒ©ã‚¦ã‚¶ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showBrowserError() {
      document.getElementById('user-display').style.display = 'none';
      document.getElementById('browser-error').style.display = 'block';
      document.getElementById('attendance').style.display = 'none';
    }
    
    // å‹¤æ€ ãƒ‡ãƒ¼ã‚¿å–å¾—
    async function fetchUserAttendance(lineUserId, year, month) {
      const attendanceEl = document.getElementById('attendance');
      
      try {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        attendanceEl.innerHTML = '<div class="loading">å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­</div>';
        console.log(`[DEBUG] å‹¤æ€ ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹: userId=${lineUserId}, year=${year}, month=${month}`);
        
        if (!lineUserId) {
          showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
          attendanceEl.innerHTML = '<div class="empty-result">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</div>';
          return;
        }

        // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆURLã‚’æ§‹ç¯‰
        const currentDate = new Date();
        const requestYear = year || currentDate.getFullYear();
        const requestMonth = month || (currentDate.getMonth() + 1);

        // JSONPæ–¹å¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®æº–å‚™
        // ä¸€æ„ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯åã‚’ç”Ÿæˆ
        const timestamp = Date.now();
        const random = Math.floor(Math.random() * 1000000);
        const jsonpCallbackName = 'kintaiCallback_' + timestamp + '_' + random;
        
        // JSONP URLæ§‹ç¯‰
        const jsonpUrl = `${API_URL}?action=getMonthlyAttendance&lineUserId=${encodeURIComponent(lineUserId)}&year=${requestYear}&month=${requestMonth.toString().padStart(2, '0')}&callback=${jsonpCallbackName}`;
        console.log('[DEBUG] JSONP URL:', jsonpUrl);
        
        // æˆåŠŸæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’è¨­å®š
        let timeoutId;
        let requestCompleted = false;
        let retries = 0;
        const MAX_RETRIES = 1; // æœ€å¤§å†è©¦è¡Œå›æ•°
        
        // JSONPå®Ÿè¡Œé–¢æ•°ï¼ˆå†è©¦è¡Œã«å¯¾å¿œï¼‰
        const executeJsonpRequest = () => {
          // ã™ã§ã«å®Œäº†ã—ã¦ã„ãŸã‚‰ä½•ã‚‚ã—ãªã„
          if (requestCompleted) return;
          
          console.log(`[DEBUG] JSONPå®Ÿè¡Œ (è©¦è¡Œ${retries + 1}/${MAX_RETRIES + 1})`);
          
          // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’è¨­å®š
          window[jsonpCallbackName] = function(data) {
            console.log('[DEBUG] ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°å®Ÿè¡Œ:', jsonpCallbackName);
            clearTimeout(timeoutId);
            requestCompleted = true;
            
            try {
              if (data && Array.isArray(data)) {
                console.log(`[DEBUG] ãƒ‡ãƒ¼ã‚¿å—ä¿¡æˆåŠŸ: ${data.length}ä»¶`);
                
                // ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆæ™‚é–“ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å­˜åœ¨ç¢ºèªï¼‰
                let validData = true;
                if (data.length > 0) {
                  for (const record of data) {
                    if (record.clockEvents && Array.isArray(record.clockEvents)) {
                      for (const event of record.clockEvents) {
                        if (event && (!event.time || typeof event.time !== 'string')) {
                          console.warn('[DEBUG] ç„¡åŠ¹ãªæ™‚é–“ãƒ‡ãƒ¼ã‚¿:', event);
                          // ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã‚’ä¿®æ­£
                          event.time = event.time ? String(event.time) : '';
                        }
                      }
                    }
                  }
                }
                
                // ãƒ‡ãƒ¼ã‚¿ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                renderTable(data, requestYear, requestMonth);
              } else if (data && data.status === 'error') {
                console.error('[DEBUG] APIã‚¨ãƒ©ãƒ¼:', data.message);
                showError(data.message || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                attendanceEl.innerHTML = `<div class="empty-result">ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã¾ã—ãŸã€‚<br>${data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}</div>`;
              } else {
                console.error('[DEBUG] ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿å½¢å¼:', data);
                showError('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ãŒè¿”ã•ã‚Œã¾ã—ãŸ');
                attendanceEl.innerHTML = '<div class="empty-result">ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã§ã™ã€‚<br>ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</div>';
              }
            } catch (err) {
              console.error('[DEBUG] ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:', err);
              showError(`ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`);
              attendanceEl.innerHTML = '<div class="empty-result">ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</div>';
            }
            
            // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å‰Šé™¤ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ï¼‰
            delete window[jsonpCallbackName];
          };
          
          // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’ä½œæˆã—ã¦JSONPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†
          const script = document.createElement('script');
          script.src = jsonpUrl;
          script.async = true;
          script.onerror = function(error) {
            console.error('[DEBUG] ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
            
            // å†è©¦è¡Œå›æ•°ãŒä¸Šé™ã«é”ã—ã¦ã„ãªã‘ã‚Œã°å†è©¦è¡Œ
            if (retries < MAX_RETRIES && !requestCompleted) {
              retries++;
              console.log(`[DEBUG] JSONPãƒªã‚¯ã‚¨ã‚¹ãƒˆå†è©¦è¡Œ (${retries}/${MAX_RETRIES})`);
              setTimeout(executeJsonpRequest, 1000); // 1ç§’å¾Œã«å†è©¦è¡Œ
            } else if (!requestCompleted) {
              showError('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
              attendanceEl.innerHTML = '<div class="empty-result">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</div>';
              requestCompleted = true;
              // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å‰Šé™¤
              delete window[jsonpCallbackName];
            }
          };
          
          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆ10ç§’ï¼‰
          timeoutId = setTimeout(() => {
            if (!requestCompleted) {
              console.log(`[DEBUG] ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿ: ${jsonpCallbackName}`);
              
              // å†è©¦è¡Œå›æ•°ãŒä¸Šé™ã«é”ã—ã¦ã„ãªã‘ã‚Œã°å†è©¦è¡Œ
              if (retries < MAX_RETRIES) {
                retries++;
                console.log(`[DEBUG] ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œã®å†è©¦è¡Œ (${retries}/${MAX_RETRIES})`);
                executeJsonpRequest(); // å†è©¦è¡Œ
              } else {
                delete window[jsonpCallbackName];
                requestCompleted = true;
                showError('ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
                attendanceEl.innerHTML = `
                  <div class="empty-result">
                    ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                    ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚<br><br>
                    <button id="direct-test" style="margin: 15px auto; padding: 10px 15px; background-color: #4a6da7; color: white; border: none; border-radius: 4px; cursor: pointer; display: block;">
                      APIã‚’ç›´æ¥ãƒ†ã‚¹ãƒˆ
                    </button>
                  </div>
                `;
                
                // ç›´æ¥ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                document.getElementById('direct-test').addEventListener('click', function() {
                  const testUrl = `${API_URL}?action=ping`;
                  window.open(testUrl, '_blank');
                });
              }
            }
          }, 10000); // 10ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
          
          // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒšãƒ¼ã‚¸ã«è¿½åŠ ã—ã¦å®Ÿè¡Œ
          document.body.appendChild(script);
        };
        
        // æœ€åˆã®JSONPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        executeJsonpRequest();
        
      } catch (error) {
        console.error('[DEBUG] äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', error);
        showError(`ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`);
        attendanceEl.innerHTML = '<div class="empty-result">äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</div>';
      }
    }
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼ã‚ˆã‚Šã‚‚æ§ãˆã‚ãªé€šçŸ¥ï¼‰
    function showMessage(message) {
      const errorEl = document.getElementById('error');
      if (!errorEl) {
        console.warn('[DEBUG] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', message);
        return;
      }
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      errorEl.style.backgroundColor = '#e8f4ff';
      errorEl.style.color = '#0066cc';
      console.log('[DEBUG] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º:', message);
      
      // 8ç§’å¾Œã«è‡ªå‹•çš„ã«æ¶ˆãˆã‚‹
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 8000);
    }
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showError(message) {
      const errorEl = document.getElementById('error');
      if (!errorEl) {
        console.error('[DEBUG] ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', message);
        return;
      }
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      console.error('[DEBUG] ã‚¨ãƒ©ãƒ¼è¡¨ç¤º:', message);
      
      // 5ç§’å¾Œã«è‡ªå‹•çš„ã«æ¶ˆãˆã‚‹
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 5000);
    }
    
    function renderTable(records, year, month) {
      const attendanceEl = document.getElementById('attendance');

      if (!Array.isArray(records) || records.length === 0) {
        // å¹´æœˆã®æŒ‡å®šãŒãªã„å ´åˆã¯ç¾åœ¨ã®å¹´æœˆã‚’ä½¿ç”¨
        const displayDate = new Date();
        const displayYear = year || displayDate.getFullYear();
        const displayMonth = month || (displayDate.getMonth() + 1);
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        const directAccessUrl = `${API_URL}?action=getMonthlyAttendance&lineUserId=${encodeURIComponent(currentLineUserId)}&year=${displayYear}&month=${displayMonth.toString().padStart(2, '0')}&format=html`;
        
        attendanceEl.innerHTML = `
          <div class="empty-result">
            ${displayYear}å¹´${displayMonth}æœˆã®å‹¤æ€ è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br><br>
            ä»¥ä¸‹ã®ç†ç”±ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ï¼š<br>
            ãƒ»æ‰“åˆ»ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„<br>
            ãƒ»LINE UserIDã¨å¾“æ¥­å“¡æƒ…å ±ãŒæ­£ã—ãç´ã¥ã‘ã‚‰ã‚Œã¦ã„ãªã„<br><br>
            
            <button id="retry-btn" style="margin: 15px auto; padding: 10px 15px; background-color: #4a6da7; color: white; border: none; border-radius: 4px; cursor: pointer; display: block;">
              å†åº¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            </button>
            
            <p>LINEãƒœãƒƒãƒˆã«ã€Œå‡ºå‹¤ã€ã‚„ã€Œé€€å‹¤ã€ãªã©ã®ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚</p>
          </div>
        `;
        
        // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ç›´æ¥URLã‚’é–‹ã
        document.getElementById('retry-btn').addEventListener('click', function() {
          window.open(directAccessUrl, '_blank');
        });
        
        return;
      }
      
      try {
        // APIãŒè¿”ã™ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚’æ¤œè¨¼
        const recordsWithValidation = records.map(rec => {
          // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
          if (!rec.date) {
            // æ—¥ä»˜ã‚’è¨­å®š
            if (rec.clockEvents && rec.clockEvents.length > 0 && rec.clockEvents[0].date) {
              rec.date = rec.clockEvents[0].date;
            }
          }
          
          // clockEventsé…åˆ—ã®ãƒã‚§ãƒƒã‚¯
          if (!rec.clockEvents || !Array.isArray(rec.clockEvents)) {
            rec.clockEvents = [];
          } else {
            // å„ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’ç¢ºèªãƒ»ä¿®æ­£
            rec.clockEvents = rec.clockEvents.map(event => {
              if (!event) return { type: 'ä¸æ˜', time: '' };
              if (!event.type) event.type = 'ä¸æ˜';
              if (!event.time || typeof event.time !== 'string') {
                event.time = event.time ? String(event.time) : '';
              }
              return event;
            });
            
            // æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆï¼ˆå®‰å…¨ã«ï¼‰
            rec.clockEvents.sort((a, b) => {
              if (!a || !a.time) return 1; 
              if (!b || !b.time) return -1;
              return String(a.time).localeCompare(String(b.time));
            });
          }
          
          return rec;
        }).filter(rec => rec.date); // æ—¥ä»˜ãŒãªã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯é™¤å¤–
        
        // æœ‰åŠ¹ãªãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã„å ´åˆ
        if (recordsWithValidation.length === 0) {
          attendanceEl.innerHTML = '<div class="empty-result">æœ‰åŠ¹ãªå‹¤æ€ è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ããªã„ã‹ã€å‹¤æ€ æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
          return;
        }
        
        // ç¾åœ¨ã®å¹´æœˆã‚’å–å¾— (å¼•æ•°ã§æ¸¡ã•ã‚ŒãŸã‚‚ã®ã‚’å„ªå…ˆ)
        const currentDisplayDate = new Date();
        const displayYear = year || currentDisplayDate.getFullYear();
        const displayMonth = month || (currentDisplayDate.getMonth() + 1);
        
        let html = `<h2>${displayYear}å¹´${displayMonth}æœˆã®å‹¤æ€ è¨˜éŒ²</h2>`;
        html += '<div class="table-container">';
        html += '<table>';
      html += '<thead><tr>';
        html += '<th>æ—¥ä»˜</th><th>å‡ºå‹¤</th><th>é€€å‹¤</th><th>åŠ´åƒæ™‚é–“</th><th>ä¼‘æ†©</th><th>æ‰“åˆ»è¨˜éŒ²</th>';
      html += '</tr></thead><tbody>';
        
        let totalWorkSeconds = 0;
        let totalBreakMinutes = 0;
        const workDaysSet = new Set();
        
        recordsWithValidation.forEach(rec => {
          // ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ¤œè¨¼
          if (!rec || typeof rec !== 'object') {
            console.warn('[DEBUG] ç„¡åŠ¹ãªãƒ¬ã‚³ãƒ¼ãƒ‰:', rec);
            return; // ç„¡åŠ¹ãªãƒ¬ã‚³ãƒ¼ãƒ‰ã¯ã‚¹ã‚­ãƒƒãƒ—
          }
          
          // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ãƒã‚§ãƒƒã‚¯
          const dateDisplay = formatDate(rec.date);
          
          // å‡ºé€€å‹¤æ™‚é–“ã‹ã‚‰æ™‚é–“éƒ¨åˆ†ã®ã¿æŠ½å‡ºã™ã‚‹é–¢æ•°
          const formatTimeOnly = (timeStr) => {
            if (!timeStr) return '-';
            let timeToFormat = timeStr;

            // timeStr ãŒ ISO 8601å½¢å¼ã®æ–‡å­—åˆ— (ä¾‹: "1899-12-30T01:12:02.000Z") ã‹ã©ã†ã‹ã‚’åˆ¤å®š
            if (typeof timeStr === 'string' && timeStr.includes('T') && timeStr.endsWith('Z')) {
              const dateObj = new Date(timeStr);
              // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç„¡åŠ¹ã§ãªã„ã‹ç¢ºèª
              if (!isNaN(dateObj.getTime())) {
                const hours = dateObj.getHours().toString().padStart(2, '0');
                const minutes = dateObj.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
              }
            }
            
            // æ–‡å­—åˆ—ã§ãªã„å ´åˆã¯æ–‡å­—åˆ—ã«å¤‰æ›
            const timeString = typeof timeToFormat === 'string' ? timeToFormat : String(timeToFormat);
            
            // HH:MM:SS å½¢å¼ã¾ãŸã¯ HH:MM å½¢å¼ã‹ã‚‰ HH:MM ã®ã¿æŠ½å‡º
            // ã‚‚ã—ã€"T"ã‚’å«ã‚“ã§ã„ãŸã‚‰ã€ãã“ã‹ã‚‰æ™‚åˆ»éƒ¨åˆ†ã ã‘ã‚’å¯¾è±¡ã«ã™ã‚‹
            const timePartMatch = timeString.match(/(\d{1,2}:\d{1,2}(:\d{1,2})?)/);
            if (timePartMatch && timePartMatch[1]) {
                 const timeOnlyMatch = timePartMatch[1].match(/^(\d{1,2}:\\d{1,2})/);
                 if (timeOnlyMatch && timeOnlyMatch[1]) {
                    return timeOnlyMatch[1];
                 }
            }
            
            // ä¸Šè¨˜ã®ã„ãšã‚Œã«ã‚‚ãƒãƒƒãƒã—ãªã„å ´åˆã¯ã€å…ƒã®æ–‡å­—åˆ—ã‚’ãã®ã¾ã¾è¿”ã™ï¼ˆã‚¨ãƒ©ãƒ¼ã‚„äºˆæœŸã›ã¬å½¢å¼ã®å ´åˆï¼‰
            return timeString;
          };
          
          const sortedEvents = (rec.clockEvents || []);
          
          const allClockEventsText = sortedEvents.map(event => {
            if (!event || !event.time || !event.type) {
              console.warn('[DEBUG] ç„¡åŠ¹ãªæ‰“åˆ»ã‚¤ãƒ™ãƒ³ãƒˆ:', event);
              return '';
            }
            // æ™‚é–“ã®è¡¨ç¤ºã‚’çŸ­ãã™ã‚‹
            const timeOnly = formatTimeOnly(event.time);
            return `${timeOnly} ${event.type}`;
          }).filter(text => text).join('<br>');
          
          let workHoursDisplay = '';
          if (rec.workingHours) {
            try {
              // workingHours ãŒ HH.mm å½¢å¼ã®å ´åˆã‚„ã€å˜ç´”ãªæ™‚é–“æ•°ã®å ´åˆã‚’è€ƒæ…®
              const workingHoursStr = typeof rec.workingHours === 'string' ? rec.workingHours : String(rec.workingHours);
              const hoursMatch = workingHoursStr.match(/^(\d+)(?:\.(\d+))?$/);
              if (hoursMatch) {
                const hours = parseInt(hoursMatch[1]);
                const minutesFraction = parseFloat("0." + (hoursMatch[2] || "0")); // 8.5æ™‚é–“ãªã©ã‚’è€ƒæ…®
                totalWorkSeconds += hours * 3600 + minutesFraction * 3600; 
              }
              
              // æ•°å€¤ã¨ã—ã¦æ‰±ãˆã‚‹ãªã‚‰è‰²åˆ†ã‘
              const workHoursNum = parseFloat(rec.workingHours);
              const colorClass = !isNaN(workHoursNum) ? 
                (workHoursNum >= 8 ? 'text-success' : (workHoursNum < 6 ? 'text-danger' : '')) : '';
              
              workHoursDisplay = `<span class="${colorClass}">${rec.workingHours}h</span>`;
            } catch (err) {
              console.warn('[DEBUG] åŠ´åƒæ™‚é–“å‡¦ç†ã‚¨ãƒ©ãƒ¼:', err);
              workHoursDisplay = `${rec.workingHours}h`;
            }
          }
          
          if (rec.breakMinutes) {
            try {
              const breakM = parseInt(typeof rec.breakMinutes === 'string' ? rec.breakMinutes : String(rec.breakMinutes));
              if (!isNaN(breakM)) {
                totalBreakMinutes += breakM;
              }
            } catch (err) {
              console.warn('[DEBUG] ä¼‘æ†©æ™‚é–“å‡¦ç†ã‚¨ãƒ©ãƒ¼:', err);
            }
          }

          // å®Ÿåƒæ—¥æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ (å‡ºå‹¤è¨˜éŒ²ãŒã‚ã‚‹æ—¥ã‚’ã‚«ã‚¦ãƒ³ãƒˆ)
          if (rec.workStart) { // workStart ãŒã‚ã‚Œã°ãã®æ—¥ã‚’å‹¤å‹™æ—¥ã¨ã™ã‚‹
              workDaysSet.add(rec.date);
          }
          
        html += `<tr>`;
          html += `<td>${dateDisplay}</td>`;
          html += `<td class="time-value">${formatTimeOnly(rec.workStart) || '-'}</td>`;
          html += `<td class="time-value">${formatTimeOnly(rec.workEnd) || '-'}</td>`;
          html += `<td>${workHoursDisplay || '-'}</td>`;
          html += `<td>${rec.breakMinutes ? rec.breakMinutes + 'åˆ†' : '-'}</td>`;
          html += `<td class="events-cell">${allClockEventsText || '-'}</td>`;
        html += `</tr>`;
      });
        
      html += '</tbody></table>';
        html += '</div>';
        
        attendanceEl.innerHTML = html;

        // é›†è¨ˆçµæœã®è¡¨ç¤º
        const totalWorkHours = Math.floor(totalWorkSeconds / 3600);
        const totalWorkRemainderMinutes = Math.floor((totalWorkSeconds % 3600) / 60);
        document.getElementById('total-work-time').textContent = `${totalWorkHours}æ™‚é–“${totalWorkRemainderMinutes}åˆ†`;

        const totalBreakHours = Math.floor(totalBreakMinutes / 60);
        const totalBreakRemainderMinutes = totalBreakMinutes % 60;
        if (totalBreakHours > 0){
          document.getElementById('total-break-time').textContent = `${totalBreakHours}æ™‚é–“${totalBreakRemainderMinutes}åˆ†`;
        } else {
          document.getElementById('total-break-time').textContent = `${totalBreakRemainderMinutes}åˆ†`;
        }
        
        document.getElementById('work-days').textContent = `${workDaysSet.size}æ—¥`;
      } catch (error) {
        console.error('[DEBUG] äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', error);
        showError(`ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`);
        attendanceEl.innerHTML = '<div class="empty-result">äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</div>';
      }
    }
    
    // æ—¥ä»˜ã‚’ã€ŒMM/DD (æ›œæ—¥)ã€å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDate(dateStr) {
      if (!dateStr) return '-';

      const date = new Date(dateStr);
      if (isNaN(date.getTime())) {
        return dateStr;
      }
      
      const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekday = weekdays[date.getDay()];
      
      return `${month}/${day} (${weekday})`;
    }
  </script>
</body>
</html>
